<html>
<head>
  <style>
    body {
      overflow: hidden;      
    }

    table {
        border-collapse: collapse;
        border: 2px black solid;
        font: 12px sans-serif;
    }

    td {
        border: 1px black solid;
        padding: 5px;
    }

    #editor {
        margin: 0;
        
        width: 90%;
        height: 50%;
    }

    .arc path {
      stroke: #fff;
    }

  </style>
	<link href="lib/c3.css" rel="stylesheet" type="text/css">
	<link href="lib/bootstrap.min.css" rel="stylesheet" type="text/css">
  <link href="lib/colorbrewer.css" rel="stylesheet" type="text/css">

	<script src="lib/d3.min.js" charset="utf-8"></script>
	<script src="lib/c3.js" type="text/javascript"></script>
	<script src="lib/peg-0.8.0.min.js" type="text/javascript"></script>
	<script src="lib/parser.js" type="text/javascript"></script>
  <script src="lib/jquery-1.11.2.min.js"></script>
  <script src="lib/src/ace.js" type="text/javascript" charset="utf-8"></script>
  <script src="lib/colorbrewer.js"></script>
  <script src="http://d3js.org/d3.v3.min.js"></script>
  <script src="donut.js"></script>  

  <script type="text/javascript">
    function parse() {
      //var text = document.getElementById("input").value;
      var text = editor.getValue();

      var parsed = parser.parse(text)
      var output = JSON.stringify(parsed, null, 4); 

      document.getElementById("chartText").style.display = 'none';
      // document.getElementById("code").innerHTML = output;

      console.log("output: "+output);

      var supportedCharts = ['bar','pie','line','area','area-spline','donut','scatter'];

      var data = [];
      var chartType = "";
      var color = "0xFFFFFF";
      var chartLabel = true

      console.log("PARSEDVALUE:")
      console.log(parsed)

      for(var i = 0; i < parsed.length; i++) {
        if (parsed[i].type == "data") {
          for(var j = 0; j < parsed[i].value.length; j++) {
            if (parsed[i].value[i].type == "file") {
              data = "";
              data = parsed[i].value[0].value;
              break;
            } else if (parsed[i].value[i].type == ("int" || "string")) {
              data[j] = parsed[i].value[j].value;              
            }
          }          
        } else if (parsed[i].type == "type") {
          if (supportedCharts.indexOf(parsed[i].value) != -1) {
            chartType = parsed[i].value;
          } else {
            console.log("Unsupported chart type!");
          }
        } else if (parsed[i].type == "color") {
          color = parsed[i].value;
        } else if (parsed[i].type == "labels") {
          chartLabel = (parsed[i].value == "true");
        } else {
          console.log("Unsupported parsing error");
        }
      }

      console.log("data: "+data);
      console.log("type: "+chartType);
      console.log("color: "+color);
      console.log("chartLabel: "+chartLabel);

      // function includeCSSfile(href) {
      //   var head_node = document.getElementsByTagName('head')[0];
      //   var link_tag = document.createElement('link');
      //   link_tag.setAttribute('rel', 'stylesheet');
      //   link_tag.setAttribute('type', 'text/css');
      //   link_tag.setAttribute('href', href);
      //   head_node.appendChild(link_tag);
      // }

      if (typeof data == "string") {
        // CSV
        if (chartType == "donut") {
          draw(data);
        }
      }
      

  //     var modData = [];

  //     parsed[0].array.forEach(function(d, i) {
  //       var item = [d.type];
  //       item.push(d.value);
  //       modData.push(item);
    //  });
      // var chart = c3.generate({
      //   data: {
      //     json: data,
      //     type: chartType,
      //     labels: chartLabel
      //   }
      // });
    }

  </script>
</head>

<body>
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-5 col-md-offset-1">
				<h3>Chart code</h3>
        <pre id="editor">
#data: data.csv
#type: donut</pre>
        <script>
            var editor = ace.edit("editor");
            editor.setTheme("ace/theme/monokai");
            editor.getSession().setMode("ace/mode/latex");
        </script>

				<input class="btn btn-default" type="submit" value="Compile" onclick="parse()" style="margin-top:10px;">
        <input class="btn btn-default" type="submit" value="SAVE SVG" style="margin-top:10px;">
        <input class="btn btn-default" type="file" id="fileUpl" style="margin-top:10px;">
			</div>
		
			<div id="right" class="col-md-5 col-md-offset-0">
				<h3>Chart</h3>
				<p id="chartText">Chart will appear here</p>
        <div id="chart" style="width: 100%; height: 400px;"></div>
			</div>
      <div id="filedata" style="visibility:visible;"></div>
		</div>
  </div>

  <script type="text/javascript">
    document.getElementById('fileUpl').onchange = function () {
      var file = this.files[0];
      var fileName = file.name;
      var reader = new FileReader();

      reader.readAsText(file);
      reader.onload = function () {
        var fileContent = this.result;

        console.log(fileContent);
        var value = document.getElementById('input').value
        value = value.split("\n");
        for(var i = 0; i < value.length; i++) {
          if(value[i].indexOf("#data") > -1) {
            value[i] = "#data: " + fileName
          }
        }
        value = value.toString().replace(/\,/g,'\n')
        document.getElementById('input').value = value;

        var data = fileContent;
        var parsedCSV = d3.csv.parseRows(data);

        var container = d3.select("#filedata")
          .append("table")
            .selectAll("tr")
              .data(parsedCSV).enter()
                .append("tr")
                  .selectAll("td")
                    .data(function(d) { return d; }).enter()
                      .append("td")
                        .text(function(d) { return d; });

      };
    }

    //File read: http://stackoverflow.com/questions/13709482/how-to-read-text-file-in-javascript
  </script>

</body>
</html>

<html>
<head>
	<link href="lib/c3.css" rel="stylesheet" type="text/css">
	<link href="lib/bootstrap.min.css" rel="stylesheet" type="text/css">

	<script src="lib/d3.min.js" charset="utf-8"></script>
	<script src="lib/c3.js" type="text/javascript"></script>
	<script src="lib/peg-0.8.0.min.js" type="text/javascript"></script>
	<script src="lib/parser.js" type="text/javascript"></script>
  <script src="lib/jquery-1.11.2.min.js"></script>
<script type="text/javascript">
        //File read: http://stackoverflow.com/questions/13709482/how-to-read-text-file-in-javascript
		function parse() {
			var text = document.getElementById("input").value;
			var parsed = parser.parse(text)
			var output = JSON.stringify(parsed, null, 4); 

			document.getElementById("chartText").style.display = 'none';
			// document.getElementById("code").innerHTML = output;

      console.log("output: "+output);

      var supportedCharts = ['bar','pie','line','area','area-spline','donut','scatter'];

      var data = [];
      var chartType = "";
      var color = "0xFFFFFF";
      var chartLabel = true

      console.log("PARSEDVALUE:")
      console.log(parsed)

      for(var i = 0; i < parsed.length; i++) {
        if (parsed[i].type == "data") {
          for(var j = 0; j < parsed[i].value.length; j++) {
            if (parsed[i].value[i].type == "file") {
              data = "";
              data = parsed[i].value[0].value;
              break;
            } else if (parsed[i].value[i].type == ("int" || "string")) {
              data[j] = parsed[i].value[j].value;              
            }
          }          
        } else if (parsed[i].type == "type") {
          if (supportedCharts.indexOf(parsed[i].value) != -1) {
            chartType = parsed[i].value;
          } else {
            console.log("Unsupported chart type!");
          }
        } else if (parsed[i].type == "color") {
          color = parsed[i].value;
        } else if (parsed[i].type == "labels") {
          chartLabel = (parsed[i].value == "true");
        } else {
          console.log("Unsupported parsing error");
        }
      }

      console.log("data: "+data);
      console.log("type: "+chartType);
      console.log("color: "+color);
      console.log("chartLabel: "+chartLabel);

      // function includeCSSfile(href) {
      //   var head_node = document.getElementsByTagName('head')[0];
      //   var link_tag = document.createElement('link');
      //   link_tag.setAttribute('rel', 'stylesheet');
      //   link_tag.setAttribute('type', 'text/css');
      //   link_tag.setAttribute('href', href);
      //   head_node.appendChild(link_tag);
      // }

      if (typeof data == "string") {
        // CSV
      }
      

  //     var modData = [];

  //     parsed[0].array.forEach(function(d, i) {
  //       var item = [d.type];
  //       item.push(d.value);
  //       modData.push(item);
		// 	});
      var chart = c3.generate({
        data: {
          json: data,
          type: chartType,
          labels: chartLabel
        }
      });
    }
	</script>	
</head>

<body onload="checkFileAPI();">
	<div class="container-fluid">
		<div class="row">
			<div class="col-md-5 col-md-offset-1">
				<h3>Chart code</h3>
				<textarea id="input" name="input" class="form-control" rows="20">
#data: 1,2,3
#type: bar
#color: red
#labels: true</textarea>
				<input class="btn btn-default" type="submit" value="Compile" onclick="parse()" style="margin-top:10px;">
        <input class="btn btn-default" type="submit" value="SAVE SVG" style="margin-top:10px;">
         <input class="btn btn-default label-info" type="file" onchange='readText(this)'>
<!--         <input class="btn btn-default" type="submit" value="Bar" onclick="parse(0)">
        <input class="btn btn-default" type="submit" value="Pie" onclick="parse(1)">
        <input class="btn btn-default" type="submit" value="Line" onclick="parse(2)">
        <input class="btn btn-default" type="submit" value="Area" onclick="parse(3)">
        <input class="btn btn-default" type="submit" value="Area Spline" onclick="parse(4)">
        <input class="btn btn-default" type="submit" value="Donut" onclick="parse(5)">
        <input class="btn btn-default" type="submit" value="Scatter" onclick="parse(6)"><br/><br/> -->

        <!-- <div id="chart" class="col-md-12 col-md-offset-0" style="height:350px;"></div> -->
			</div>
		
			<div id="right" class="col-md-5 col-md-offset-0">
				<h3>Chart</h3>
				<p id="chartText">Chart will appear here</p>
        <div id="chart"></div>
			</div>
		</div>
	</div>
  <script type="text/javascript">
        var reader;
      function checkFileAPI() {
          if (window.File && window.FileReader && window.FileList && window.Blob) {
              reader = new FileReader();
              return true; 
          } else {
              alert('The File APIs are not fully supported by your browser. Fallback required.');
              return false;
          }
      }

    
      function readText(filePath) {
          var output = "";
          if(filePath.files && filePath.files[0]) {           
              reader.onload = function (e) {
                  output = e.target.result;
                  displayContents(output);
              };//end onload()
              reader.readAsText(filePath.files[0]);
          }
          else if(ActiveXObject && filePath) {
              try {
                  reader = new ActiveXObject("Scripting.FileSystemObject");
                  var file = reader.OpenTextFile(filePath, 1);
                  output = file.ReadAll();
                  file.Close();
                  displayContents(output);
              } catch (e) {
                  if (e.number == -2146827859) {
                      console.log("error")
                  }
              }       
          }
          else {
              return false;
          }       
          return true;
      }   

      function displayContents(txt) {
        var addType = "type= csv\n"
          $('#input').val(addType + txt);
      }   
  </script>
</body>
</html>
